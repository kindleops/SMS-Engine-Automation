services:
  - type: web
    name: rei-sms-engine
    env: python
    plan: free
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn sms.main:app --host 0.0.0.0 --port 10000
    envVars:
      - key: AIRTABLE_API_KEY
        sync: false
      - key: AIRTABLE_LEADS_CONVOS_BASE_ID
        sync: false
      - key: AIRTABLE_CAMPAIGN_CONTROL_BASE_ID
        sync: false
      - key: AIRTABLE_PERFORMANCE_BASE_ID
        sync: false
      - key: TEXTGRID_ACCOUNT_SID
        sync: false
      - key: TEXTGRID_AUTH_TOKEN
        sync: false
      - key: CRON_TOKEN
        sync: false

cronjobs:
  # üîÑ Autoresponder (always on, every 10 min)
  - name: run-autoresponder
    schedule: "*/10 * * * *"
    command: |
      curl -sS -X POST "https://rei-sms-engine.onrender.com/autoresponder" \
        -H "x-cron-token: $CRON_TOKEN"

  # üöÄ Campaign runner ‚Äî checks Airtable for scheduled campaigns
  - name: run-campaigns
    schedule: "*/10 * * * *"   # every 10 minutes
    command: |
      curl -sS -X POST "https://rei-sms-engine.onrender.com/run-campaigns?limit=ALL" \
        -H "x-cron-token: $CRON_TOKEN"

  # üìä Update metrics every 30 minutes
  - name: update-metrics
    schedule: "*/30 * * * *"
    command: |
      curl -sS -X POST "https://rei-sms-engine.onrender.com/metrics" \
        -H "x-cron-token: $CRON_TOKEN"

  # üîÅ Retry runner ‚Äî every 30 minutes
  - name: sms-retry-runner
    schedule: "*/30 * * * *"
    command: |
      curl -sS -X POST "https://rei-sms-engine.onrender.com/retry" \
        -H "x-cron-token: $CRON_TOKEN"

  # üåô Reset quotas ‚Äî nightly at midnight UTC
  - name: reset-daily-quotas
    schedule: "0 0 * * *"
    command: |
      curl -sS -X POST "https://rei-sms-engine.onrender.com/reset-quotas" \
        -H "x-cron-token: $CRON_TOKEN"

  # ‚ù§Ô∏è Health ping ‚Äî every 5 minutes to keep service warm
  - name: health-ping
    schedule: "*/5 * * * *"
    command: |
      curl -sS "https://rei-sms-engine.onrender.com/health"

  # üìà KPI Aggregation 
  - name: aggregate-kpis-daily
    schedule: "0 1 * * *" # daily at 1 AM UTC
    command: |
      curl -sS -X POST "https://rei-sms-engine.onrender.com/aggregate-kpis" \
        -H "x-cron-token: $CRON_TOKEN"

  - name: aggregate-kpis-weekly
    schedule: "0 2 * * 1" # every Monday at 2 AM UTC
    command: |
      curl -sS -X POST "https://rei-sms-engine.onrender.com/aggregate-kpis" \
        -H "x-cron-token: $CRON_TOKEN"

  - name: aggregate-kpis-monthly
    schedule: "0 3 1 * *" # first of the month at 3 AM UTC
    command: |
      curl -sS -X POST "https://rei-sms-engine.onrender.com/aggregate-kpis" \
        -H "x-cron-token: $CRON_TOKEN"
  