# =====================================================
#  REI SMS Engine — Full Render Deployment (FINAL AUTOPILOT)
#  Single source of truth: Scheduler queues; Worker sends.
#  /schedule-campaigns cron replaces /run-campaigns.
# =====================================================

services:
  # 🌐 MAIN WEB SERVICE — API + Webhooks + Cron Endpoints
  - type: web
    name: rei-sms-engine
    env: python
    plan: free
    runtime: python3.11
    buildCommand: |
      pip install --upgrade pip setuptools wheel
      pip install --no-cache-dir -r requirements.txt
    startCommand: uvicorn sms.main:app --host 0.0.0.0 --port $PORT
    autoDeploy: true
    previews:
      enabled: false
    healthCheckPath: /health
    envVars:
      # === Airtable Credentials ===
      - key: AIRTABLE_API_KEY
        sync: false
      - key: LEADS_CONVOS_BASE
        sync: false
      - key: AIRTABLE_LEADS_CONVOS_BASE_ID
        sync: false
      - key: CAMPAIGN_CONTROL_BASE
        sync: false
      - key: AIRTABLE_CAMPAIGN_CONTROL_BASE_ID
        sync: false
      - key: PERFORMANCE_BASE
        sync: false
      - key: AIRTABLE_PERFORMANCE_BASE_ID
        sync: false
      - key: AIRTABLE_REPORTING_KEY
        sync: false

      # === TextGrid / SMS Provider ===
      - key: TEXTGRID_ACCOUNT_SID
        sync: false
      - key: TEXTGRID_AUTH_TOKEN
        sync: false

      # === Tokens & Auth ===
      - key: WEBHOOK_TOKEN
        sync: false
      - key: CRON_TOKEN
        sync: false

      # === Redis / Upstash (optional for locks/counters) ===
      - key: UPSTASH_REDIS_REST_URL
        sync: false
      - key: UPSTASH_REDIS_REST_TOKEN
        sync: false
      - key: REDIS_TLS
        value: "true"

      # === Operational Toggles ===
      - key: ENABLE_CAMPAIGNS
        value: "true"          # exposes /schedule-campaigns
      - key: RUNNER_SEND_AFTER_QUEUE
        value: "true"          # worker will pick up queued items
      - key: ENABLE_METRICS
        value: "true"

      # === Quiet Hours (America/Chicago) ===
      - key: QUIET_HOURS_ENFORCED
        value: "true"
      - key: QUIET_START_HOUR_LOCAL
        value: "21"
      - key: QUIET_END_HOUR_LOCAL
        value: "9"

      # === Global Rate/limits (worker respects these) ===
      - key: GLOBAL_RATE_PER_MIN
        value: "5000"
      - key: RATE_PER_NUMBER_PER_MIN
        value: "20"
      - key: DAILY_LIMIT
        value: "750"
      - key: DEDUPE_HOURS
        value: "72"
      - key: MESSAGES_PER_MIN
        value: "20"
      - key: JITTER_SECONDS
        value: "2"

      # === Debugging / Mode Flags ===
      - key: LOG_LEVEL
        value: "debug"
      - key: TEST_MODE
        value: "false"
      - key: STRICT_MODE
        value: "false"

    resources:
      cpu: 1
      memoryMB: 512

  # ♾️ CONTINUOUS WORKER — Outbound, Retry, Autoresponder, Metrics
  - type: worker
    name: rei-sms-worker
    env: python
    plan: free
    runtime: python3.11
    buildCommand: |
      pip install --upgrade pip setuptools wheel
      pip install --no-cache-dir -r requirements.txt
    startCommand: python -u -m sms.worker
    autoDeploy: true
    previews:
      enabled: false
    envVars:
      - key: AIRTABLE_API_KEY
        sync: false
      - key: LEADS_CONVOS_BASE
        sync: false
      - key: CAMPAIGN_CONTROL_BASE
        sync: false
      - key: PERFORMANCE_BASE
        sync: false
      - key: TEXTGRID_ACCOUNT_SID
        sync: false
      - key: TEXTGRID_AUTH_TOKEN
        sync: false
      - key: UPSTASH_REDIS_REST_URL
        sync: false
      - key: UPSTASH_REDIS_REST_TOKEN
        sync: false
      - key: REDIS_TLS
        value: "true"

      # Worker cadence & limits
      - key: WORKER_INTERVAL_SEC
        value: "30"
      - key: SEND_BATCH_LIMIT
        value: "500"
      - key: RETRY_LIMIT
        value: "100"
      - key: AUTORESPONDER_LIMIT
        value: "50"
      - key: AUTORESPONDER_VIEW
        value: "Unprocessed Inbounds"

      # Feature flags
      - key: ENABLE_CAMPAIGNS
        value: "true"
      - key: RUNNER_SEND_AFTER_QUEUE
        value: "true"
      - key: ENABLE_METRICS
        value: "true"

      # Quiet hours
      - key: QUIET_HOURS_ENFORCED
        value: "true"
      - key: QUIET_START_HOUR_LOCAL
        value: "21"
      - key: QUIET_END_HOUR_LOCAL
        value: "9"

      # Auth
      - key: WEBHOOK_TOKEN
        sync: false
      - key: CRON_TOKEN
        sync: false

      # Debug
      - key: STRICT_MODE
        value: "false"

# =====================================================
#  Cron Jobs — Automated Engine Orchestration
# =====================================================
cronJobs:
  # ✅ NEW: Scheduler queues campaigns (replaces old /run-campaigns)
  - name: schedule-campaigns
    schedule: "*/5 * * * *"
    command: >
      curl -sf -X POST "https://rei-sms-engine.onrender.com/schedule-campaigns"
      -H "Authorization: Bearer ${CRON_TOKEN}"
      -H "x-cron-token: ${CRON_TOKEN}"

  # Autoresponder pass
  - name: run-autoresponder
    schedule: "*/10 * * * *"
    command: >
      curl -sf -X POST "https://rei-sms-engine.onrender.com/autoresponder/autoresponder"
      -H "Authorization: Bearer ${CRON_TOKEN}"
      -H "x-cron-token: ${CRON_TOKEN}"

  # Retry/backoff pass
  - name: sms-retry-runner
    schedule: "*/30 * * * *"
    command: >
      curl -sf -X POST "https://rei-sms-engine.onrender.com/retry"
      -H "Authorization: Bearer ${CRON_TOKEN}"
      -H "x-cron-token: ${CRON_TOKEN}"

  # Reset daily quotas
  - name: reset-daily-quotas
    schedule: "0 0 * * *"
    command: >
      curl -sf -X POST "https://rei-sms-engine.onrender.com/reset-quotas"
      -H "Authorization: Bearer ${CRON_TOKEN}"
      -H "x-cron-token: ${CRON_TOKEN}"

  # KPI aggregation
  - name: aggregate-kpis-daily
    schedule: "0 1 * * *"
    command: >
      curl -sf -X POST "https://rei-sms-engine.onrender.com/aggregate-kpis"
      -H "Authorization: Bearer ${CRON_TOKEN}"
      -H "x-cron-token: ${CRON_TOKEN}"

  # Health ping
  - name: health-ping
    schedule: "*/5 * * * *"
    command: >
      curl -sf "https://rei-sms-engine.onrender.com/health"